{% extends "auctions/layout.html" %}

{% block body %}
    <h2>Active Listings</h2>

    {% for auction in auctions %}
        <div>
            <ul>
                <li>Author: {{auction.user}}</li>
                <li>Title: {{auction.title}}</li>
                <li>Description: {{auction.description}}</li>
                <li>Category: {{auction.category}}</li>
                {% if auction.last_bid %}
                    <li id="lastBid" class="lastBid{{auction.id}}" value="{{auction.last_bid.bid}}">Last Bid: {{auction.last_bid.bid}}</li>
                {% else %}
                    <li id="initialBid" class="lastBid{{auction.id}}" value="{{auction.starting_bid}}">Initial Bid: {{auction.starting_bid}}</li>
                {% endif %}
                {% if request.user != auction.user %}
                <form id="addBid" data-auction="{{auction.id}}" action="{% url 'bid_to_auction' auction=auction.id %}">
                    {% csrf_token %}
                    <input type="number" name="totalBid" id="newBid" placeholder="Total bid">
                    <button type="submit">Send</button>
                </form>
                {% endif %}
            </ul>
        </div>
        <form id="addToWatchlist" action="{% url 'add_to_watchlist' auction=auction.id %}">
            {% csrf_token %}
            <button class="btn btn-dark" type="submit">Add to Watchlist</button>
        </form>
    {% endfor %}

    <script type="text/javascript">
        $(document).on('submit', '#addToWatchlist', function(e){
            e.preventDefault();

            $.ajax({
                type:'POST',
                url: $(this).attr('action'),
                data: $(this).serialize(),
                success:function(){
                    var watchlist = document.getElementById('watchListTotal')
                    actualValue = watchlist.getAttribute('value')
                    watchlist.innerHTML = parseInt(actualValue) + 1
                }
            })
        });

        $(document).on('submit', '#addBid', function(e){
            e.preventDefault();
            auction = $(this).data("auction")
            newBid = $('#newBid').val()
            lastBid = $(`.lastBid${auction}`).val()
            console.log(newBid, lastBid)

            if(newBid > 0 && newBid > lastBid){
                $.ajax({
                    type:'POST',
                    url: $(this).attr('action'),
                    data: $(this).serialize(),
                    success: function() {
                        console.log("OK")
                        $(`.lastBid${auction}`).val(newBid)
                        $(`.lastBid${auction}`).html(`Last Bid: ${newBid}`)
                        $('#newBid').val('')
                    }
                });
            }
        })
    </script>
    
{% endblock %}